项目深挖

### 数据发送方式

- XHR
- img标签
- sendBeacon

https://developer.mozilla.org/zh-CN/docs/Web/API/Navigator/sendBeacon

为什么选用sendBeacon

在离开页面时需要发送数据

过去，为了解决这个问题， 统计和诊断代码通常要在

- 发起一个同步 `XMLHttpRequest` 来发送数据。
- 创建一个 [``](https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/img) 元素并设置 `src`，大部分用户代理会延迟卸载（unload）文档以加载图像。
- 创建一个几秒的 no-op 循环。

上述的所有方法都会迫使用户代理延迟卸载文档，并使得下一个导航出现的更晚。下一个页面对于这种较差的载入表现无能为力。

这就是 **`sendBeacon()`** 方法存在的意义。使用 **`sendBeacon()`** 方法会使用户代理在有机会时异步地向服务器发送数据，同时不会延迟页面的卸载或影响下一导航的载入性能，这意味着：

- 数据发送是可靠的。
- 数据异步传输。
- 不影响下一导航的载入。

### 避免使用 unload 和 beforeunload

过去，许多网站使用 `unload (en-US)` 或 `beforeunload (en-US)` 事件以在会话结束时发送统计数据。然而这是不可靠的，在许多情况下（尤其是移动设备）浏览器不会产生 `unload`、`beforeunload` 或 `pagehide` 事件。下面列出了一种不触发上述事件的情况：

1. 用户加载了网页并与其交互。
2. 完成浏览后，用户切换到了其它应用程序，而不是关闭选项卡。
3. 随后，用户通过手机的应用管理器关闭了浏览器应用。

#### 使用 pagehide 作为回退 pageshow作为前进,visibility change切换选项卡

可使用 `pagehide (en-US)` 事件来代替部分浏览器未实现的 `visibilitychange` 事件。和 `beforeunload` 与 `unload` 事件类似，这一事件不会被可靠地触发（特别是在移动设备上），但它与 bfcache 兼容。

示例代码使用 `visibilitychange (en-US)` 事件来调用 `sendBeacon()` 以发送统计数据。

```js
document.addEventListener('visibilitychange', function logData() {
  if (document.visibilityState === 'hidden') {
    navigator.sendBeacon('/log', analyticsData);
  }
});
```